<!doctype html>
<html lang="es">
  <head>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-180.png" />
    <link rel="icon" href="favicon.ico" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Mi Jornada</title>

    <!-- Metaetiquetas para iOS (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Mi Jornada" />
    <meta name="theme-color" content="#fce7f3" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Fuentes Kawaii -->
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              kawaii: ["Comfortaa", "cursive"],
              chunky: ["Fredoka", "sans-serif"],
            },
            colors: {
              // Paleta Hello Kitty / Draculaura
              "kitty-bg": "#fff0f5",
              "kitty-card": "#ffffff",
              "kitty-accent": "#ff69b4",
              "kitty-text": "#d63384",
              "kitty-soft": "#fce7f3",

              // Paleta Kuromi
              "kuromi-bg": "#1a1a1a",
              "kuromi-card": "#2d2d2d",
              "kuromi-accent": "#a78bfa",
              "kuromi-text": "#e9d5ff",
              "kuromi-dark": "#000000",
            },
            spacing: {
              "safe-top": "env(safe-area-inset-top)",
              "safe-bottom": "env(safe-area-inset-bottom)",
            },
          },
        },
      };
    </script>

    <style>
      /* Estilos base */
      body {
        font-family: "Comfortaa", cursive;
        -webkit-tap-highlight-color: transparent;
        transition:
          background-color 0.5s ease,
          color 0.5s ease;
      }

      /* Correcci√≥n Notch iPhone */
      header {
        padding-top: env(safe-area-inset-top);
        height: calc(70px + env(safe-area-inset-top));
      }

      main {
        padding-top: calc(80px + env(safe-area-inset-top));
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
      }

      .bottom-nav {
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(70px + env(safe-area-inset-bottom));
      }

      /* Utilidades */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      input:focus {
        outline: none;
        transform: scale(1.02);
        transition: all 0.2s ease;
      }

      input[type="date"],
      input[type="time"],
      input[type="number"] {
        appearance: none;
        -webkit-appearance: none;
      }

      /* Fondos y Temas */
      .bg-pattern-light {
        background-color: #fff0f5;
        background-image: radial-gradient(#ffb7b2 2px, transparent 2px);
        background-size: 20px 20px;
      }

      .dark .bg-pattern-dark {
        background-color: #18181b;
        background-image: radial-gradient(#4c1d95 2px, transparent 2px);
        background-size: 20px 20px;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
        100% {
          transform: translateY(0px);
        }
      }
      .floating-icon {
        animation: float 3s ease-in-out infinite;
      }

      /* Calendario */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        font-size: 0.8rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
      }
      .calendar-day.empty {
        background: transparent;
        cursor: default;
      }
      .has-work::after {
        content: "";
        position: absolute;
        bottom: 4px;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: currentColor;
      }

      /* Pesta√±as */
      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
      .tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Checkbox Personalizado */
      .custom-checkbox {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .dark .custom-checkbox {
        border-color: #555;
      }

      .row-selected .custom-checkbox {
        background-color: #ec4899;
        border-color: #ec4899;
        color: white;
      }
      .dark .row-selected .custom-checkbox {
        background-color: #9333ea;
        border-color: #9333ea;
      }

      /* Widget Flotante */
      .selection-widget {
        position: fixed;
        bottom: calc(80px + env(safe-area-inset-bottom));
        left: 50%;
        transform: translateX(-50%) translateY(200%);
        width: 90%;
        max-width: 400px;
        z-index: 40;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .selection-widget.visible {
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body
    class="bg-pattern-light min-h-screen text-gray-800 dark:text-gray-100 transition-colors duration-500 pb-safe-bottom"
  >
    <!-- HEADER -->
    <header
      class="fixed top-0 left-0 w-full z-50 bg-white/90 dark:bg-black/90 backdrop-blur-md border-b border-pink-200 dark:border-purple-900 shadow-sm transition-colors duration-500 flex items-center"
    >
      <div class="w-full flex justify-between items-center px-6 pb-2 pt-2">
        <div class="flex items-center gap-2">
          <i
            class="fa-solid fa-heart text-kitty-accent dark:text-kuromi-accent text-2xl floating-icon"
          ></i>
          <h1
            class="font-chunky text-2xl text-kitty-text dark:text-kuromi-accent tracking-wide"
          >
            Workie
          </h1>
        </div>

        <button
          onclick="toggleTheme()"
          class="relative w-14 h-8 bg-pink-200 dark:bg-purple-900 rounded-full shadow-inner transition-colors duration-300 focus:outline-none touch-manipulation"
        >
          <div
            id="toggle-circle"
            class="absolute top-1 left-1 w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center text-xs"
          >
            üéÄ
          </div>
        </button>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="px-5 max-w-md mx-auto space-y-6">
      <!-- PESTA√ëA 1: INICIO (Fichar) -->
      <div id="tab-home" class="tab-content active">
        <!-- Resumen -->
        <div
          class="bg-white dark:bg-zinc-800 rounded-3xl p-6 shadow-lg border-2 border-pink-100 dark:border-purple-900 relative overflow-hidden transition-colors duration-500 mb-6"
        >
          <div
            class="absolute -right-4 -top-4 text-8xl opacity-10 rotate-12 select-none"
          >
            <span class="dark:hidden">üíñ</span>
            <span class="hidden dark:block">üíÄ</span>
          </div>
          <h2
            class="text-sm font-bold uppercase tracking-widest text-gray-400 dark:text-gray-500 mb-1"
          >
            Total Hist√≥rico
          </h2>
          <div class="flex items-baseline gap-1">
            <span
              class="text-4xl font-chunky text-kitty-text dark:text-kuromi-accent"
              id="total-earnings"
              >0.00</span
            >
            <span class="text-xl font-bold text-gray-500">‚Ç¨</span>
          </div>
          <div class="mt-2 flex gap-4 text-xs text-gray-400">
            <span
              >‚úÖ Cobrado:
              <span id="paid-total" class="font-bold text-green-500"
                >0.00‚Ç¨</span
              ></span
            >
            <span
              >‚è≥ Pendiente:
              <span id="pending-total" class="font-bold text-orange-400"
                >0.00‚Ç¨</span
              ></span
            >
          </div>
        </div>

        <!-- Formulario -->
        <div
          class="bg-white/90 dark:bg-zinc-900/90 backdrop-blur rounded-3xl p-6 shadow-xl border border-pink-200 dark:border-purple-800 transition-colors duration-500"
        >
          <h3
            class="font-chunky text-xl text-center mb-4 text-gray-700 dark:text-white"
          >
            <i
              class="fa-solid fa-pen-fancy mr-2 text-pink-400 dark:text-purple-400"
            ></i
            >Nuevo Turno
          </h3>

          <div class="mb-4">
            <label class="text-xs font-bold text-gray-500 ml-2"
              >Pago por Hora (‚Ç¨)</label
            >
            <input
              type="number"
              id="hourly-rate"
              class="w-full bg-pink-50 dark:bg-zinc-800 rounded-2xl px-4 py-3 mt-1 font-bold text-lg text-kitty-text dark:text-kuromi-accent border-2 border-transparent focus:border-pink-300 dark:focus:border-purple-500 transition-colors placeholder-gray-400"
              placeholder="Ej: 10.50"
              step="0.50"
            />
          </div>

          <div class="mb-4">
            <label class="text-xs font-bold text-gray-500 ml-2">Fecha</label>
            <input
              type="date"
              id="work-date"
              class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-4 py-3 mt-1 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700 focus:border-pink-300 dark:focus:border-purple-500"
            />
          </div>

          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="text-xs font-bold text-gray-500 ml-2"
                >Entrada</label
              >
              <input
                type="time"
                id="start-time"
                class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-2 py-3 mt-1 text-center font-bold text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
              />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 ml-2">Salida</label>
              <input
                type="time"
                id="end-time"
                class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-2 py-3 mt-1 text-center font-bold text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
              />
            </div>
          </div>

          <button
            onclick="addEntry()"
            class="w-full py-4 rounded-2xl bg-gradient-to-r from-pink-400 to-rose-400 dark:from-purple-600 dark:to-indigo-600 text-white font-chunky text-lg shadow-lg shadow-pink-200 dark:shadow-purple-900/50 transform active:scale-95 transition-all flex justify-center items-center gap-2"
          >
            <i class="fa-solid fa-check"></i> ¬°Apuntar!
          </button>
        </div>
      </div>

      <!-- PESTA√ëA 2: AGENDA -->
      <div id="tab-calendar" class="tab-content">
        <!-- Calendario -->
        <div
          class="bg-white/80 dark:bg-zinc-900/80 backdrop-blur rounded-3xl p-5 shadow-xl border border-pink-200 dark:border-purple-800 transition-colors duration-500 mb-6"
        >
          <div class="flex justify-between items-center mb-4">
            <button
              onclick="changeMonth(-1)"
              class="w-8 h-8 rounded-full bg-pink-100 dark:bg-zinc-700 text-pink-500 dark:text-purple-300 flex items-center justify-center active:scale-90 transition"
            >
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h3
              id="calendar-month-year"
              class="font-chunky text-lg capitalize text-gray-700 dark:text-gray-200"
            >
              Enero 2024
            </h3>
            <button
              onclick="changeMonth(1)"
              class="w-8 h-8 rounded-full bg-pink-100 dark:bg-zinc-700 text-pink-500 dark:text-purple-300 flex items-center justify-center active:scale-90 transition"
            >
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>

          <div
            class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400"
          >
            <div>L</div>
            <div>M</div>
            <div>X</div>
            <div>J</div>
            <div>V</div>
            <div>S</div>
            <div>D</div>
          </div>

          <div id="calendar-days" class="calendar-grid mb-4"></div>

          <div
            class="bg-pink-50 dark:bg-zinc-800/50 rounded-xl p-3 flex justify-between items-center border border-pink-100 dark:border-purple-900/30"
          >
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400"
              >Total este mes:</span
            >
            <span
              id="month-earnings"
              class="font-chunky text-lg text-kitty-text dark:text-kuromi-accent"
              >0.00‚Ç¨</span
            >
          </div>
        </div>

        <!-- Lista -->
        <div>
          <div class="flex justify-between items-end mb-3 px-2">
            <h3 class="font-chunky text-lg text-gray-600 dark:text-gray-300">
              Historial
            </h3>
            <p class="text-[10px] text-gray-400">Selecciona para calcular</p>
          </div>

          <div id="entries-list" class="space-y-4 pb-20"></div>
        </div>
      </div>

      <!-- PESTA√ëA 3: AJUSTES -->
      <div id="tab-settings" class="tab-content">
        <h3
          class="font-chunky text-2xl text-gray-700 dark:text-white mb-6 ml-2"
        >
          Ajustes
        </h3>

        <!-- Configuraci√≥n Tarifa -->
        <div
          class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-purple-900/30 mb-6"
        >
          <h4
            class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4"
          >
            Configuraci√≥n
          </h4>

          <div class="mb-2">
            <label class="text-sm font-bold text-gray-600 dark:text-gray-300"
              >Tarifa por defecto (‚Ç¨/h)</label
            >
            <div class="flex gap-2 mt-2">
              <input
                type="number"
                id="settings-rate"
                class="flex-1 bg-gray-50 dark:bg-zinc-800 rounded-xl px-4 py-2 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
                placeholder="10.00"
                step="0.50"
              />
              <button
                onclick="saveDefaultRate()"
                class="bg-pink-100 dark:bg-purple-900 text-pink-500 dark:text-purple-300 px-4 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition"
              >
                Guardar
              </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">
              Este valor se aplicar√° autom√°ticamente al crear turnos.
            </p>
          </div>
        </div>

        <!-- Backup -->
        <div
          class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-purple-900/30 mb-6"
        >
          <h4
            class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4"
          >
            Copia de Seguridad
          </h4>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button
              onclick="backupData()"
              class="flex flex-col items-center justify-center p-4 rounded-2xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/50 text-green-600 dark:text-green-400 active:scale-95 transition-transform"
            >
              <i class="fa-solid fa-cloud-arrow-down text-2xl mb-2"></i>
              <span class="text-xs font-bold">Guardar Copia</span>
            </button>
            <button
              onclick="document.getElementById('file-input').click()"
              class="flex flex-col items-center justify-center p-4 rounded-2xl bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800/50 text-orange-600 dark:text-orange-400 active:scale-95 transition-transform"
            >
              <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
              <span class="text-xs font-bold">Restaurar</span>
            </button>
          </div>
          <input
            type="file"
            id="file-input"
            accept=".json"
            class="hidden"
            onchange="restoreData(this)"
          />
        </div>

        <!-- Peligro -->
        <div
          class="bg-red-50 dark:bg-red-900/10 rounded-3xl p-5 border border-red-100 dark:border-red-900/30"
        >
          <h4
            class="text-xs font-bold text-red-400 uppercase tracking-widest mb-4"
          >
            Zona de Peligro
          </h4>
          <button
            onclick="clearAllData()"
            class="w-full py-3 bg-white dark:bg-zinc-800 text-red-500 dark:text-red-400 font-bold rounded-xl border border-red-200 dark:border-red-900 shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-2"
          >
            <i class="fa-solid fa-trash-can"></i> Borrar Todo
          </button>
        </div>

        <div class="text-center mt-8 opacity-40">
          <p class="font-kawaii text-xs">Workie App v3.1</p>
        </div>
      </div>
    </main>

    <!-- WIDGET FLOTANTE -->
    <div
      id="selection-widget"
      class="selection-widget bg-white dark:bg-zinc-800 rounded-2xl shadow-2xl border-2 border-pink-200 dark:border-purple-600 p-4 flex flex-col gap-3"
    >
      <div
        class="flex justify-between items-center border-b border-gray-100 dark:border-gray-700 pb-2"
      >
        <div class="flex items-center gap-2">
          <span
            class="bg-pink-100 dark:bg-purple-900 text-pink-600 dark:text-purple-300 font-bold px-2 py-0.5 rounded-md text-xs"
            id="selection-count"
            >0</span
          >
          <span class="text-xs text-gray-500 dark:text-gray-400">selec.</span>
        </div>
        <div class="text-right">
          <div class="text-[10px] text-gray-400 uppercase font-bold">
            Total Selecci√≥n
          </div>
          <div
            class="font-chunky text-lg text-kitty-text dark:text-kuromi-accent"
            id="selection-total"
          >
            0.00‚Ç¨
          </div>
        </div>
      </div>
      <div class="flex gap-2">
        <button
          onclick="markSelected(true)"
          class="flex-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 py-2 rounded-xl text-xs font-bold active:scale-95 transition"
        >
          <i class="fa-solid fa-check mr-1"></i> Cobrado
        </button>
        <button
          onclick="markSelected(false)"
          class="flex-1 bg-orange-100 dark:bg-orange-900/30 text-orange-500 dark:text-orange-400 py-2 rounded-xl text-xs font-bold active:scale-95 transition"
        >
          <i class="fa-regular fa-clock mr-1"></i> Pendiente
        </button>
        <button
          onclick="clearSelection()"
          class="w-10 flex items-center justify-center bg-gray-100 dark:bg-zinc-700 text-gray-500 rounded-xl active:scale-95"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <!-- NAVBAR -->
    <nav
      class="bottom-nav fixed bottom-0 left-0 w-full bg-white/90 dark:bg-black/90 backdrop-blur-xl border-t border-gray-200 dark:border-gray-800 z-50 flex justify-around items-start pt-3 transition-colors duration-500"
    >
      <button
        onclick="switchTab('home')"
        id="nav-home"
        class="flex flex-col items-center gap-1 w-16 text-pink-500 dark:text-purple-400 transition-colors"
      >
        <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Fichar</span>
      </button>
      <button
        onclick="switchTab('calendar')"
        id="nav-calendar"
        class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-pink-400 dark:hover:text-purple-300 transition-colors"
      >
        <i class="fa-solid fa-calendar-days text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Agenda</span>
      </button>
      <button
        onclick="switchTab('settings')"
        id="nav-settings"
        class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-pink-400 dark:hover:text-purple-300 transition-colors"
      >
        <i class="fa-solid fa-gear text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Ajustes</span>
      </button>
    </nav>

    <!-- MODALES -->
    <div
      id="modal-overlay"
      class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4"
    >
      <div
        id="modal-content"
        class="bg-white dark:bg-zinc-800 w-full max-w-xs rounded-[2rem] p-6 shadow-2xl transform scale-95 transition-all duration-300 border-2 border-pink-100 dark:border-purple-900 relative"
      >
        <div
          id="modal-icon"
          class="text-5xl text-center mb-4 filter drop-shadow-md"
        ></div>
        <h3
          id="modal-title"
          class="font-chunky text-xl text-center text-gray-800 dark:text-white mb-2 leading-tight"
        ></h3>
        <div
          id="modal-message"
          class="text-center text-sm text-gray-500 dark:text-gray-300 mb-6 font-kawaii leading-relaxed"
        ></div>
        <div id="modal-buttons" class="flex gap-3 justify-center"></div>
      </div>
    </div>

    <div
      id="edit-modal-overlay"
      class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4"
    >
      <div
        id="edit-modal-content"
        class="bg-white dark:bg-zinc-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transform scale-95 transition-all duration-300 border-2 border-blue-100 dark:border-blue-900"
      >
        <h3
          class="font-chunky text-xl text-center text-gray-800 dark:text-white mb-4"
        >
          Editar Turno ‚úèÔ∏è
        </h3>
        <input type="hidden" id="edit-id" />
        <div class="space-y-3 mb-6">
          <div>
            <label class="text-xs font-bold text-gray-500 ml-2">Fecha</label>
            <input
              type="date"
              id="edit-date"
              class="w-full bg-gray-50 dark:bg-zinc-700 rounded-xl px-4 py-2 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600"
            />
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="text-xs font-bold text-gray-500 ml-2"
                >Entrada</label
              >
              <input
                type="time"
                id="edit-start"
                class="w-full bg-gray-50 dark:bg-zinc-700 rounded-xl px-2 py-2 text-center text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600"
              />
            </div>
            <div class="flex-1">
              <label class="text-xs font-bold text-gray-500 ml-2">Salida</label>
              <input
                type="time"
                id="edit-end"
                class="w-full bg-gray-50 dark:bg-zinc-700 rounded-xl px-2 py-2 text-center text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600"
              />
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 ml-2"
              >Tarifa (‚Ç¨/h)</label
            >
            <input
              type="number"
              id="edit-rate"
              class="w-full bg-gray-50 dark:bg-zinc-700 rounded-xl px-4 py-2 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600"
              step="0.50"
            />
          </div>
        </div>
        <div class="flex gap-3">
          <button
            onclick="closeEditModal()"
            class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-zinc-700 text-gray-500 dark:text-gray-300 font-bold text-sm active:scale-95 transition"
          >
            Cancelar
          </button>
          <button
            onclick="saveEdit()"
            class="flex-1 py-3 rounded-xl bg-blue-500 text-white font-bold text-sm shadow-lg active:scale-95 transition"
          >
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script>
      // --- ESTADO ---
      let entries = JSON.parse(localStorage.getItem("workEntries")) || [];
      let savedRate = localStorage.getItem("hourlyRate") || "";
      let isDark = localStorage.getItem("theme") === "dark";
      let currentCalendarDate = new Date();
      let selectedEntryIds = new Set();

      // --- INICIO ---
      window.onload = () => {
        document.getElementById("work-date").valueAsDate = new Date();
        // Cargar tarifa guardada en ambos inputs al iniciar
        if (savedRate) {
          document.getElementById("hourly-rate").value = savedRate;
          document.getElementById("settings-rate").value = savedRate;
        }
        applyTheme();
        updateApp();
      };

      // --- PESTA√ëAS ---
      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`tab-${tabName}`).classList.add("active");

        const navIds = ["nav-home", "nav-calendar", "nav-settings"];
        navIds.forEach((id) => {
          document.getElementById(id).className =
            "flex flex-col items-center gap-1 w-16 text-gray-400 transition-colors";
        });
        document.getElementById(`nav-${tabName}`).className =
          "flex flex-col items-center gap-1 w-16 text-pink-500 dark:text-purple-400 transition-colors scale-110";

        if (tabName === "calendar") renderCalendar();
      }

      // --- CORE & DATA ---
      function updateApp() {
        entries.forEach((e) => {
          if (typeof e.paid === "undefined") e.paid = false;
        });
        entries.sort((a, b) => {
          const dateA = new Date(a.date + "T" + a.start);
          const dateB = new Date(b.date + "T" + b.start);
          return dateB - dateA;
        });
        localStorage.setItem("workEntries", JSON.stringify(entries));
        renderEntries();
        renderCalendar();
        updateTotals();
        updateSelectionWidget();
      }

      function updateTotals() {
        let total = 0,
          paid = 0,
          pending = 0;
        entries.forEach((e) => {
          const val = parseFloat(e.earned);
          total += val;
          if (e.paid) paid += val;
          else pending += val;
        });
        document.getElementById("total-earnings").innerText = total.toFixed(2);
        document.getElementById("paid-total").innerText = paid.toFixed(2) + "‚Ç¨";
        document.getElementById("pending-total").innerText =
          pending.toFixed(2) + "‚Ç¨";
      }

      // --- AJUSTES DE TARIFA (ARREGLADO) ---
      function saveDefaultRate() {
        const val = document.getElementById("settings-rate").value;
        if (val) {
          localStorage.setItem("hourlyRate", val);
          savedRate = val;
          // Actualizar inmediatamente el input principal
          document.getElementById("hourly-rate").value = val;

          showModal({
            title: "Guardado",
            message: "Tarifa actualizada y aplicada al formulario.",
            icon: "üíæ",
          });
        }
      }

      // --- A√ëADIR TURNO ---
      function addEntry() {
        const rate = parseFloat(document.getElementById("hourly-rate").value);
        const date = document.getElementById("work-date").value;
        const start = document.getElementById("start-time").value;
        const end = document.getElementById("end-time").value;

        if (!rate || !date || !start || !end) {
          showModal({ title: "¬°Ups!", message: "Faltan datos.", icon: "ü§î" });
          return;
        }

        // Si no hab√≠a tarifa guardada, la guardamos ahora
        if (!localStorage.getItem("hourlyRate")) {
          localStorage.setItem("hourlyRate", rate);
          savedRate = rate;
        }

        const calc = calculateEarnings(date, start, end, rate);

        entries.push({
          id: Date.now(),
          date: date,
          start: start,
          end: end,
          rate: rate,
          hours: calc.hours,
          earned: calc.earned,
          paid: false,
        });

        document.getElementById("start-time").value = "";
        document.getElementById("end-time").value = "";

        updateApp();
        showModal({
          title: "¬°Apuntado!",
          message: `Ganado: <b>${calc.earned}‚Ç¨</b>`,
          icon: isDark ? "ü¶á" : "üéÄ",
        });
      }

      function calculateEarnings(date, start, end, rate) {
        const startTime = new Date(`2000-01-01T${start}`);
        let endTime = new Date(`2000-01-01T${end}`);
        if (endTime < startTime) endTime.setDate(endTime.getDate() + 1);
        const diffHrs = (endTime - startTime) / (1000 * 60 * 60);
        return {
          hours: diffHrs.toFixed(2),
          earned: (diffHrs * rate).toFixed(2),
        };
      }

      // --- LISTA Y SELECCI√ìN ---
      function toggleSelection(id) {
        if (selectedEntryIds.has(id)) selectedEntryIds.delete(id);
        else selectedEntryIds.add(id);
        renderEntries();
        updateSelectionWidget();
      }

      function clearSelection() {
        selectedEntryIds.clear();
        renderEntries();
        updateSelectionWidget();
      }

      function updateSelectionWidget() {
        const widget = document.getElementById("selection-widget");
        const countEl = document.getElementById("selection-count");
        const totalEl = document.getElementById("selection-total");

        if (selectedEntryIds.size > 0) {
          widget.classList.add("visible");
          countEl.innerText = selectedEntryIds.size;
          let sum = 0;
          entries.forEach((e) => {
            if (selectedEntryIds.has(e.id)) sum += parseFloat(e.earned);
          });
          totalEl.innerText = sum.toFixed(2) + "‚Ç¨";
        } else {
          widget.classList.remove("visible");
        }
      }

      function markSelected(isPaid) {
        entries.forEach((e) => {
          if (selectedEntryIds.has(e.id)) e.paid = isPaid;
        });
        updateApp();
        clearSelection();
        showModal({
          title: isPaid ? "¬°Cobrado!" : "Pendiente",
          message: "Estado actualizado.",
          icon: isPaid ? "ü§ë" : "üìù",
        });
      }

      function renderEntries() {
        const container = document.getElementById("entries-list");
        container.innerHTML = "";
        if (entries.length === 0) {
          container.innerHTML = `<div class="text-center py-10 opacity-50"><p>Lista vac√≠a...</p></div>`;
          return;
        }
        const grouped = {};
        entries.forEach((entry) => {
          if (!grouped[entry.date]) grouped[entry.date] = [];
          grouped[entry.date].push(entry);
        });
        Object.keys(grouped).forEach((dateKey) => {
          const dayEntries = grouped[dateKey];
          const dateObj = new Date(dateKey);
          const dayName = dateObj.toLocaleDateString("es-ES", {
            weekday: "long",
            day: "numeric",
            month: "long",
          });
          const dayContainer = document.createElement("div");
          dayContainer.className =
            "bg-white dark:bg-zinc-800 rounded-2xl shadow-sm border border-pink-100 dark:border-purple-900 overflow-hidden animate-fade-in";
          let shiftsHTML = "";
          dayEntries.forEach((shift) => {
            const isSelected = selectedEntryIds.has(shift.id);
            const paidBadge = shift.paid
              ? `<span class="text-[10px] bg-green-100 text-green-600 px-2 rounded-full font-bold ml-2">COBRADO</span>`
              : "";
            shiftsHTML += `
                        <div class="flex items-center py-3 px-4 border-t border-gray-100 dark:border-gray-700 first:border-t-0 hover:bg-pink-50 dark:hover:bg-zinc-700/50 transition-colors ${isSelected ? "row-selected bg-pink-50 dark:bg-zinc-700" : ""}">
                            <div class="mr-3 cursor-pointer p-2 -ml-2" onclick="toggleSelection(${shift.id})">
                                <div class="custom-checkbox">${isSelected ? '<i class="fa-solid fa-check text-xs"></i>' : ""}</div>
                            </div>
                            <div class="flex-1 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="bg-pink-100 dark:bg-purple-900/50 text-pink-500 dark:text-purple-300 rounded-lg p-2 text-xs font-bold min-w-[60px] text-center">
                                        ${shift.start}<br>‚¨á<br>${shift.end}
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 dark:text-gray-200 flex items-center">${shift.hours} h ${paidBadge}</div>
                                        <div class="text-xs text-gray-400">@ ${shift.rate}‚Ç¨/h</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-chunky text-lg ${shift.paid ? "text-green-500" : "text-kitty-text dark:text-kuromi-accent"}">+${shift.earned}‚Ç¨</span>
                                    <button onclick="openEditModal(${shift.id})" class="text-gray-300 hover:text-blue-400 p-2"><i class="fa-solid fa-pencil text-sm"></i></button>
                                    <button onclick="deleteEntry(${shift.id})" class="text-gray-300 hover:text-red-400 p-2 -mr-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                </div>
                            </div>
                        </div>`;
          });
          dayContainer.innerHTML = `<div class="bg-pink-50 dark:bg-zinc-900 px-4 py-2 flex justify-between items-center"><span class="font-bold text-sm text-gray-600 dark:text-gray-300 capitalize">${dayName}</span></div><div>${shiftsHTML}</div>`;
          container.appendChild(dayContainer);
        });
      }

      // --- EDICI√ìN ---
      function openEditModal(id) {
        const entry = entries.find((e) => e.id === id);
        if (!entry) return;
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-date").value = entry.date;
        document.getElementById("edit-start").value = entry.start;
        document.getElementById("edit-end").value = entry.end;
        document.getElementById("edit-rate").value = entry.rate;
        const overlay = document.getElementById("edit-modal-overlay");
        const content = document.getElementById("edit-modal-content");
        overlay.classList.remove("hidden");
        setTimeout(() => {
          overlay.classList.remove("opacity-0");
          content.classList.add("scale-100");
        }, 10);
      }
      function closeEditModal() {
        const overlay = document.getElementById("edit-modal-overlay");
        const content = document.getElementById("edit-modal-content");
        overlay.classList.add("opacity-0");
        content.classList.remove("scale-100");
        setTimeout(() => overlay.classList.add("hidden"), 300);
      }
      function saveEdit() {
        const id = parseInt(document.getElementById("edit-id").value);
        const date = document.getElementById("edit-date").value;
        const start = document.getElementById("edit-start").value;
        const end = document.getElementById("edit-end").value;
        const rate = parseFloat(document.getElementById("edit-rate").value);
        if (!rate || !date || !start || !end) {
          alert("Faltan datos");
          return;
        }
        const index = entries.findIndex((e) => e.id === id);
        if (index !== -1) {
          const calc = calculateEarnings(date, start, end, rate);
          entries[index] = {
            ...entries[index],
            date,
            start,
            end,
            rate,
            hours: calc.hours,
            earned: calc.earned,
          };
          updateApp();
          closeEditModal();
          showModal({
            title: "Editado",
            message: "Turno actualizado.",
            icon: "üìù",
          });
        }
      }
      function deleteEntry(id) {
        showModal({
          title: "¬øBorrar?",
          message: "No podr√°s recuperarlo.",
          icon: "üóëÔ∏è",
          type: "confirm",
          onConfirm: () => {
            entries = entries.filter((e) => e.id !== id);
            if (selectedEntryIds.has(id)) selectedEntryIds.delete(id);
            updateApp();
          },
        });
      }

      // --- CALENDARIO & HELPERS ---
      function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
      }
      function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        document.getElementById("calendar-month-year").textContent =
          currentCalendarDate.toLocaleDateString("es-ES", {
            month: "long",
            year: "numeric",
          });
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let startDay = firstDay.getDay() - 1;
        if (startDay === -1) startDay = 6;
        const grid = document.getElementById("calendar-days");
        grid.innerHTML = "";
        for (let i = 0; i < startDay; i++)
          grid.appendChild(document.createElement("div"));
        let monthTotal = 0;
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const dayWork = entries.filter((e) => e.date === dateStr);
          dayWork.forEach((w) => (monthTotal += parseFloat(w.earned)));
          const el = document.createElement("div");
          let classes =
            "calendar-day font-bold text-gray-600 dark:text-gray-400";
          if (
            day === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
          )
            classes +=
              " border-2 border-pink-400 dark:border-purple-400 text-pink-500 dark:text-purple-300";
          if (dayWork.length > 0) {
            const allPaid = dayWork.every((w) => w.paid);
            classes += allPaid
              ? " bg-green-400 text-white shadow-md has-work"
              : " bg-pink-400 dark:bg-purple-600 text-white shadow-md has-work";
            el.onclick = () => {
              const t = dayWork
                .reduce((a, b) => a + parseFloat(b.earned), 0)
                .toFixed(2);
              showModal({
                title: `D√≠a ${day}`,
                message: `Total: <b>${t}‚Ç¨</b>`,
                icon: "üìÖ",
              });
            };
          }
          el.className = classes;
          el.innerText = day;
          grid.appendChild(el);
        }
        document.getElementById("month-earnings").innerText =
          `${monthTotal.toFixed(2)}‚Ç¨`;
      }
      function toggleTheme() {
        isDark = !isDark;
        localStorage.setItem("theme", isDark ? "dark" : "light");
        applyTheme();
      }
      function applyTheme() {
        const html = document.documentElement;
        const body = document.body;
        const tBtn = document.getElementById("toggle-circle");
        if (isDark) {
          html.classList.add("dark");
          body.classList.replace("bg-pattern-light", "bg-pattern-dark");
          tBtn.style.transform = "translateX(24px)";
          tBtn.innerText = "üíÄ";
          tBtn.parentElement.classList.replace("bg-pink-200", "bg-purple-900");
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute("content", "#18181b");
        } else {
          html.classList.remove("dark");
          body.classList.replace("bg-pattern-dark", "bg-pattern-light");
          tBtn.style.transform = "translateX(0px)";
          tBtn.innerText = "üéÄ";
          tBtn.parentElement.classList.replace("bg-purple-900", "bg-pink-200");
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute("content", "#fce7f3");
        }
      }
      function showModal({
        title,
        message,
        icon = "‚ú®",
        type = "info",
        onConfirm,
      }) {
        const overlay = document.getElementById("modal-overlay");
        const content = document.getElementById("modal-content");
        document.getElementById("modal-icon").innerHTML = icon;
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-message").innerHTML = message;
        const btnContainer = document.getElementById("modal-buttons");
        btnContainer.innerHTML = "";
        if (type === "confirm") {
          const btnCancel = document.createElement("button");
          btnCancel.className =
            "flex-1 py-3 rounded-xl bg-gray-100 dark:bg-zinc-700 text-gray-500 font-bold text-sm";
          btnCancel.innerText = "Cancelar";
          btnCancel.onclick = closeModal;
          const btnConfirm = document.createElement("button");
          btnConfirm.className =
            "flex-1 py-3 rounded-xl bg-pink-500 text-white font-bold text-sm shadow-lg";
          btnConfirm.innerText = "S√≠";
          btnConfirm.onclick = () => {
            if (onConfirm) onConfirm();
            closeModal();
          };
          btnContainer.append(btnCancel, btnConfirm);
        } else {
          const btnOk = document.createElement("button");
          btnOk.className =
            "w-full py-3 rounded-xl bg-pink-400 text-white font-bold text-sm shadow-lg";
          btnOk.innerText = "OK";
          btnOk.onclick = closeModal;
          btnContainer.appendChild(btnOk);
        }
        overlay.classList.remove("hidden");
        setTimeout(() => {
          overlay.classList.remove("opacity-0");
          content.classList.add("scale-100");
        }, 10);
      }
      function closeModal() {
        const overlay = document.getElementById("modal-overlay");
        overlay.classList.add("opacity-0");
        setTimeout(() => overlay.classList.add("hidden"), 300);
      }
      function backupData() {
        const b = {
          entries,
          hourlyRate: savedRate,
          theme: isDark ? "dark" : "light",
          backupDate: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(b)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `workie_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      }
      function restoreData(input) {
        const file = input.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = (e) => {
          try {
            const d = JSON.parse(e.target.result);
            if (d.entries) {
              entries = d.entries;
              if (d.hourlyRate)
                localStorage.setItem("hourlyRate", d.hourlyRate);
              if (d.theme) localStorage.setItem("theme", d.theme);
              updateApp();
              showModal({
                title: "Restaurado",
                message: "Datos recuperados",
                icon: "üîÑ",
              });
            }
          } catch (e) {
            alert("Error archivo");
          }
        };
        r.readAsText(file);
        input.value = "";
      }
      function clearAllData() {
        entries = [];
        updateApp();
        showModal({
          title: "Borrado",
          message: "Historial limpio",
          icon: "üßπ",
        });
      }
    </script>
  </body>
</html>
