<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Work Kawaii Tracker</title>

    <!-- Metaetiquetas para iOS (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Work Tracker" />
    <meta name="theme-color" content="#fce7f3" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Fuentes Kawaii -->
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              kawaii: ["Comfortaa", "cursive"],
              chunky: ["Fredoka", "sans-serif"],
            },
            colors: {
              // Paleta Hello Kitty / Draculaura
              "kitty-bg": "#fff0f5",
              "kitty-card": "#ffffff",
              "kitty-accent": "#ff69b4",
              "kitty-text": "#d63384",
              "kitty-soft": "#fce7f3",

              // Paleta Kuromi
              "kuromi-bg": "#1a1a1a",
              "kuromi-card": "#2d2d2d",
              "kuromi-accent": "#a78bfa",
              "kuromi-text": "#e9d5ff",
              "kuromi-dark": "#000000",
            },
            spacing: {
              "safe-top": "env(safe-area-inset-top)",
              "safe-bottom": "env(safe-area-inset-bottom)",
            },
          },
        },
      };
    </script>

    <style>
      /* Estilos base y animaciones */
      body {
        font-family: "Comfortaa", cursive;
        -webkit-tap-highlight-color: transparent;
        transition:
          background-color 0.5s ease,
          color 0.5s ease;
      }

      /* Correcci√≥n CR√çTICA para el Notch del iPhone */
      header {
        padding-top: env(safe-area-inset-top);
        height: calc(70px + env(safe-area-inset-top));
      }

      main {
        padding-top: calc(80px + env(safe-area-inset-top));
        padding-bottom: calc(
          100px + env(safe-area-inset-bottom)
        ); /* Espacio para la navbar */
      }

      /* Navbar inferior */
      .bottom-nav {
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(70px + env(safe-area-inset-bottom));
      }

      /* Ocultar scrollbar pero permitir scroll */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Animaci√≥n suave para inputs */
      input:focus {
        outline: none;
        transform: scale(1.02);
        transition: all 0.2s ease;
      }

      /* Estilo iOS para inputs */
      input[type="date"],
      input[type="time"],
      input[type="number"] {
        appearance: none;
        -webkit-appearance: none;
      }

      /* Fondos */
      .bg-pattern-light {
        background-color: #fff0f5;
        background-image: radial-gradient(#ffb7b2 2px, transparent 2px);
        background-size: 20px 20px;
      }

      .dark .bg-pattern-dark {
        background-color: #18181b;
        background-image: radial-gradient(#4c1d95 2px, transparent 2px);
        background-size: 20px 20px;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
        100% {
          transform: translateY(0px);
        }
      }
      .floating-icon {
        animation: float 3s ease-in-out infinite;
      }

      /* Estilos Calendario */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px; /* C√≠rculo perfecto */
        font-size: 0.8rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
      }
      .calendar-day.empty {
        background: transparent;
        cursor: default;
      }

      .has-work::after {
        content: "";
        position: absolute;
        bottom: 4px;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: currentColor;
      }

      /* Animaci√≥n Fade In para pesta√±as */
      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
      .tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body
    class="bg-pattern-light min-h-screen text-gray-800 dark:text-gray-100 transition-colors duration-500 pb-safe-bottom"
  >
    <!-- HEADER -->
    <header
      class="fixed top-0 left-0 w-full z-50 bg-white/90 dark:bg-black/90 backdrop-blur-md border-b border-pink-200 dark:border-purple-900 shadow-sm transition-colors duration-500 flex items-center"
    >
      <div class="w-full flex justify-between items-center px-6 pb-2 pt-2">
        <div class="flex items-center gap-2">
          <i
            class="fa-solid fa-heart text-kitty-accent dark:text-kuromi-accent text-2xl floating-icon"
          ></i>
          <h1
            class="font-chunky text-2xl text-kitty-text dark:text-kuromi-accent tracking-wide"
          >
            Workie
          </h1>
        </div>

        <button
          onclick="toggleTheme()"
          class="relative w-14 h-8 bg-pink-200 dark:bg-purple-900 rounded-full shadow-inner transition-colors duration-300 focus:outline-none touch-manipulation"
        >
          <div
            id="toggle-circle"
            class="absolute top-1 left-1 w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center text-xs"
          >
            üéÄ
          </div>
        </button>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="px-5 max-w-md mx-auto space-y-6">
      <!-- PESTA√ëA 1: INICIO (Fichar) -->
      <div id="tab-home" class="tab-content active">
        <!-- Tarjeta Resumen -->
        <div
          class="bg-white dark:bg-zinc-800 rounded-3xl p-6 shadow-lg border-2 border-pink-100 dark:border-purple-900 relative overflow-hidden transition-colors duration-500 mb-6"
        >
          <div
            class="absolute -right-4 -top-4 text-8xl opacity-10 rotate-12 select-none"
          >
            <span class="dark:hidden">üíñ</span>
            <span class="hidden dark:block">üíÄ</span>
          </div>
          <h2
            class="text-sm font-bold uppercase tracking-widest text-gray-400 dark:text-gray-500 mb-1"
          >
            Total Hist√≥rico
          </h2>
          <div class="flex items-baseline gap-1">
            <span
              class="text-4xl font-chunky text-kitty-text dark:text-kuromi-accent"
              id="total-earnings"
              >0.00</span
            >
            <span class="text-xl font-bold text-gray-500">‚Ç¨</span>
          </div>
        </div>

        <!-- Formulario de Entrada -->
        <div
          class="bg-white/90 dark:bg-zinc-900/90 backdrop-blur rounded-3xl p-6 shadow-xl border border-pink-200 dark:border-purple-800 transition-colors duration-500"
        >
          <h3
            class="font-chunky text-xl text-center mb-4 text-gray-700 dark:text-white"
          >
            <i
              class="fa-solid fa-pen-fancy mr-2 text-pink-400 dark:text-purple-400"
            ></i
            >Nuevo Turno
          </h3>

          <div class="mb-4">
            <label class="text-xs font-bold text-gray-500 ml-2"
              >Pago por Hora (‚Ç¨)</label
            >
            <input
              type="number"
              id="hourly-rate"
              class="w-full bg-pink-50 dark:bg-zinc-800 rounded-2xl px-4 py-3 mt-1 font-bold text-lg text-kitty-text dark:text-kuromi-accent border-2 border-transparent focus:border-pink-300 dark:focus:border-purple-500 transition-colors placeholder-gray-400"
              placeholder="Ej: 10.50"
              step="0.50"
            />
          </div>

          <div class="mb-4">
            <label class="text-xs font-bold text-gray-500 ml-2">Fecha</label>
            <input
              type="date"
              id="work-date"
              class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-4 py-3 mt-1 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700 focus:border-pink-300 dark:focus:border-purple-500"
            />
          </div>

          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="text-xs font-bold text-gray-500 ml-2"
                >Entrada</label
              >
              <input
                type="time"
                id="start-time"
                class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-2 py-3 mt-1 text-center font-bold text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
              />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 ml-2">Salida</label>
              <input
                type="time"
                id="end-time"
                class="w-full bg-gray-50 dark:bg-zinc-800 rounded-2xl px-2 py-3 mt-1 text-center font-bold text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
              />
            </div>
          </div>

          <button
            onclick="addEntry()"
            class="w-full py-4 rounded-2xl bg-gradient-to-r from-pink-400 to-rose-400 dark:from-purple-600 dark:to-indigo-600 text-white font-chunky text-lg shadow-lg shadow-pink-200 dark:shadow-purple-900/50 transform active:scale-95 transition-all flex justify-center items-center gap-2"
          >
            <i class="fa-solid fa-check"></i> ¬°Apuntar!
          </button>
        </div>
      </div>

      <!-- PESTA√ëA 2: AGENDA (Calendario + Lista) -->
      <div id="tab-calendar" class="tab-content">
        <!-- Widget de Calendario -->
        <div
          class="bg-white/80 dark:bg-zinc-900/80 backdrop-blur rounded-3xl p-5 shadow-xl border border-pink-200 dark:border-purple-800 transition-colors duration-500 mb-6"
        >
          <!-- Header Calendario -->
          <div class="flex justify-between items-center mb-4">
            <button
              onclick="changeMonth(-1)"
              class="w-8 h-8 rounded-full bg-pink-100 dark:bg-zinc-700 text-pink-500 dark:text-purple-300 flex items-center justify-center active:scale-90 transition"
            >
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h3
              id="calendar-month-year"
              class="font-chunky text-lg capitalize text-gray-700 dark:text-gray-200"
            >
              Enero 2024
            </h3>
            <button
              onclick="changeMonth(1)"
              class="w-8 h-8 rounded-full bg-pink-100 dark:bg-zinc-700 text-pink-500 dark:text-purple-300 flex items-center justify-center active:scale-90 transition"
            >
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>

          <!-- D√≠as Semana -->
          <div
            class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400"
          >
            <div>L</div>
            <div>M</div>
            <div>X</div>
            <div>J</div>
            <div>V</div>
            <div>S</div>
            <div>D</div>
          </div>

          <!-- Grid D√≠as -->
          <div id="calendar-days" class="calendar-grid mb-4">
            <!-- JS rellena esto -->
          </div>

          <!-- Resumen Mensual -->
          <div
            class="bg-pink-50 dark:bg-zinc-800/50 rounded-xl p-3 flex justify-between items-center border border-pink-100 dark:border-purple-900/30"
          >
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400"
              >Total este mes:</span
            >
            <span
              id="month-earnings"
              class="font-chunky text-lg text-kitty-text dark:text-kuromi-accent"
              >0.00‚Ç¨</span
            >
          </div>
        </div>

        <!-- Lista de Historial -->
        <div>
          <div class="flex justify-between items-end mb-3 px-2">
            <h3 class="font-chunky text-lg text-gray-600 dark:text-gray-300">
              Historial
            </h3>
            <button
              onclick="copyToClipboard()"
              class="text-xs bg-white dark:bg-zinc-800 px-3 py-1.5 rounded-full shadow text-blue-400 dark:text-blue-300 font-bold border border-pink-100 dark:border-purple-900 active:scale-95 flex items-center gap-1"
            >
              <i class="fa-regular fa-copy"></i> Copiar Notas
            </button>
          </div>

          <div id="entries-list" class="space-y-4">
            <!-- Se rellena con JS -->
          </div>
        </div>
      </div>

      <!-- PESTA√ëA 3: AJUSTES -->
      <div id="tab-settings" class="tab-content">
        <h3
          class="font-chunky text-2xl text-gray-700 dark:text-white mb-6 ml-2"
        >
          Ajustes
        </h3>

        <!-- Configuraci√≥n General -->
        <div
          class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-purple-900/30 mb-6"
        >
          <h4
            class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4"
          >
            Configuraci√≥n
          </h4>

          <div class="mb-2">
            <label class="text-sm font-bold text-gray-600 dark:text-gray-300"
              >Tarifa por defecto (‚Ç¨/h)</label
            >
            <div class="flex gap-2 mt-2">
              <input
                type="number"
                id="settings-rate"
                class="flex-1 bg-gray-50 dark:bg-zinc-800 rounded-xl px-4 py-2 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700"
                placeholder="10.00"
              />
              <button
                onclick="saveDefaultRate()"
                class="bg-pink-100 dark:bg-purple-900 text-pink-500 dark:text-purple-300 px-4 rounded-xl font-bold text-sm"
              >
                Guardar
              </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">
              Este valor aparecer√° autom√°ticamente cuando crees un nuevo turno.
            </p>
          </div>
        </div>

        <!-- Gesti√≥n de Datos -->
        <div
          class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-purple-900/30 mb-6"
        >
          <h4
            class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4"
          >
            Copia de Seguridad
          </h4>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <button
              onclick="backupData()"
              class="flex flex-col items-center justify-center p-4 rounded-2xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/50 text-green-600 dark:text-green-400 active:scale-95 transition-transform"
            >
              <i class="fa-solid fa-cloud-arrow-down text-2xl mb-2"></i>
              <span class="text-xs font-bold">Guardar Copia</span>
            </button>
            <button
              onclick="document.getElementById('file-input').click()"
              class="flex flex-col items-center justify-center p-4 rounded-2xl bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800/50 text-orange-600 dark:text-orange-400 active:scale-95 transition-transform"
            >
              <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
              <span class="text-xs font-bold">Restaurar</span>
            </button>
          </div>

          <input
            type="file"
            id="file-input"
            accept=".json"
            class="hidden"
            onchange="restoreData(this)"
          />
          <p class="text-xs text-gray-400 text-center">
            Guarda una copia de tus datos por si borras el historial o cambias
            de m√≥vil.
          </p>
        </div>

        <!-- Zona de Peligro -->
        <div
          class="bg-red-50 dark:bg-red-900/10 rounded-3xl p-5 border border-red-100 dark:border-red-900/30"
        >
          <h4
            class="text-xs font-bold text-red-400 uppercase tracking-widest mb-4"
          >
            Zona de Peligro
          </h4>
          <button
            onclick="clearAllData()"
            class="w-full py-3 bg-white dark:bg-zinc-800 text-red-500 dark:text-red-400 font-bold rounded-xl border border-red-200 dark:border-red-900 shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-2"
          >
            <i class="fa-solid fa-trash-can"></i> Borrar Todo
          </button>
        </div>

        <div class="text-center mt-8 opacity-40">
          <p class="font-kawaii text-xs">Workie App v2.1</p>
        </div>
      </div>
    </main>

    <!-- NAVIGATION BAR -->
    <nav
      class="bottom-nav fixed bottom-0 left-0 w-full bg-white/90 dark:bg-black/90 backdrop-blur-xl border-t border-gray-200 dark:border-gray-800 z-50 flex justify-around items-start pt-3 transition-colors duration-500"
    >
      <button
        onclick="switchTab('home')"
        id="nav-home"
        class="flex flex-col items-center gap-1 w-16 text-pink-500 dark:text-purple-400 transition-colors"
      >
        <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Fichar</span>
      </button>
      <button
        onclick="switchTab('calendar')"
        id="nav-calendar"
        class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-pink-400 dark:hover:text-purple-300 transition-colors"
      >
        <i class="fa-solid fa-calendar-days text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Agenda</span>
      </button>
      <button
        onclick="switchTab('settings')"
        id="nav-settings"
        class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-pink-400 dark:hover:text-purple-300 transition-colors"
      >
        <i class="fa-solid fa-gear text-xl mb-1"></i>
        <span class="text-[10px] font-bold">Ajustes</span>
      </button>
    </nav>

    <!-- COMPONENTE MODAL GLOBAL -->
    <div
      id="modal-overlay"
      class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4"
    >
      <div
        id="modal-content"
        class="bg-white dark:bg-zinc-800 w-full max-w-xs rounded-[2rem] p-6 shadow-2xl transform scale-95 transition-all duration-300 border-2 border-pink-100 dark:border-purple-900 relative"
      >
        <!-- Decoraci√≥n esquina (opcional) -->
        <div class="absolute -top-3 -right-3 text-2xl animate-bounce">
          <span class="dark:hidden">‚ú®</span>
          <span class="hidden dark:block">ü¶á</span>
        </div>

        <!-- Icono -->
        <div
          id="modal-icon"
          class="text-5xl text-center mb-4 filter drop-shadow-md"
        ></div>

        <!-- T√≠tulo -->
        <h3
          id="modal-title"
          class="font-chunky text-xl text-center text-gray-800 dark:text-white mb-2 leading-tight"
        ></h3>

        <!-- Mensaje -->
        <div
          id="modal-message"
          class="text-center text-sm text-gray-500 dark:text-gray-300 mb-6 font-kawaii leading-relaxed"
        ></div>

        <!-- Botones -->
        <div id="modal-buttons" class="flex gap-3 justify-center">
          <!-- Se inyectan din√°micamente -->
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script>
      // --- ELEMENTOS Y ESTADO ---
      const toggleBtn = document.getElementById("toggle-circle");
      const listContainer = document.getElementById("entries-list");
      const totalEarningsEl = document.getElementById("total-earnings");

      // Widget Calendario
      const calendarMonthYear = document.getElementById("calendar-month-year");
      const calendarGrid = document.getElementById("calendar-days");
      const monthEarningsEl = document.getElementById("month-earnings");

      // Inputs
      const rateInput = document.getElementById("hourly-rate");
      const settingsRateInput = document.getElementById("settings-rate"); // Nuevo input en ajustes
      const dateInput = document.getElementById("work-date");
      const startInput = document.getElementById("start-time");
      const endInput = document.getElementById("end-time");

      let entries = JSON.parse(localStorage.getItem("workEntries")) || [];
      let savedRate = localStorage.getItem("hourlyRate") || "";
      let isDark = localStorage.getItem("theme") === "dark";

      // Fecha actual del calendario
      let currentCalendarDate = new Date();

      window.onload = () => {
        dateInput.valueAsDate = new Date();

        // Cargar tarifa guardada en ambos inputs
        if (savedRate) {
          rateInput.value = savedRate;
          settingsRateInput.value = savedRate;
        }

        applyTheme();
        updateApp();
      };

      // --- SISTEMA DE PESTA√ëAS ---
      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`tab-${tabName}`).classList.add("active");

        const navIds = ["nav-home", "nav-calendar", "nav-settings"];
        navIds.forEach((id) => {
          document.getElementById(id).className =
            "flex flex-col items-center gap-1 w-16 text-gray-400 transition-colors";
        });

        document.getElementById(`nav-${tabName}`).className =
          "flex flex-col items-center gap-1 w-16 text-pink-500 dark:text-purple-400 transition-colors scale-110";

        if (tabName === "calendar") renderCalendar();
      }

      // --- CORE FUNCTIONS ---
      function updateApp() {
        entries.sort((a, b) => {
          const dateA = new Date(a.date + "T" + a.start);
          const dateB = new Date(b.date + "T" + b.start);
          return dateB - dateA;
        });

        saveData();
        renderEntries();
        renderCalendar();
      }

      function toggleTheme() {
        isDark = !isDark;
        localStorage.setItem("theme", isDark ? "dark" : "light");
        applyTheme();
      }

      function applyTheme() {
        const html = document.documentElement;
        const body = document.body;
        if (isDark) {
          html.classList.add("dark");
          body.classList.remove("bg-pattern-light");
          body.classList.add("bg-pattern-dark");
          toggleBtn.style.transform = "translateX(24px)";
          toggleBtn.innerText = "üíÄ";
          toggleBtn.classList.remove("bg-white", "text-pink-500");
          toggleBtn.classList.add("bg-zinc-800", "text-purple-500");
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute("content", "#18181b");
        } else {
          html.classList.remove("dark");
          body.classList.remove("bg-pattern-dark");
          body.classList.add("bg-pattern-light");
          toggleBtn.style.transform = "translateX(0px)";
          toggleBtn.innerText = "üéÄ";
          toggleBtn.classList.remove("bg-zinc-800", "text-purple-500");
          toggleBtn.classList.add("bg-white", "text-pink-500");
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute("content", "#fce7f3");
        }
      }

      // --- CALENDARIO ---
      function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
      }

      function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        calendarMonthYear.textContent = currentCalendarDate.toLocaleDateString(
          "es-ES",
          { month: "long", year: "numeric" },
        );

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();

        let startDay = firstDay.getDay() - 1;
        if (startDay === -1) startDay = 6;

        calendarGrid.innerHTML = "";
        let monthTotal = 0;

        for (let i = 0; i < startDay; i++) {
          const empty = document.createElement("div");
          empty.className = "calendar-day empty";
          calendarGrid.appendChild(empty);
        }

        const today = new Date();

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const dayWork = entries.filter((e) => e.date === dateStr);
          const hasWork = dayWork.length > 0;

          if (hasWork) {
            dayWork.forEach((w) => (monthTotal += parseFloat(w.earned)));
          }

          const dayEl = document.createElement("div");
          let classes =
            "calendar-day font-bold text-gray-600 dark:text-gray-400";

          if (
            day === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
          ) {
            classes +=
              " border-2 border-pink-400 dark:border-purple-400 text-pink-500 dark:text-purple-300";
          }

          if (hasWork) {
            classes +=
              " bg-pink-400 dark:bg-purple-600 text-white shadow-md has-work";
            // NUEVO MODAL PARA DETALLES DEL D√çA
            dayEl.onclick = () => {
              const dayTotal = dayWork
                .reduce((a, b) => a + parseFloat(b.earned), 0)
                .toFixed(2);
              let detailMsg = `Ganado total: <b>${dayTotal}‚Ç¨</b><br><br>`;
              dayWork.forEach((w) => {
                detailMsg += `‚è∞ ${w.start} - ${w.end} (${w.hours}h)<br>`;
              });

              showModal({
                title: `Resumen del ${day}`,
                message: detailMsg,
                icon: isDark ? "üíÄ" : "üìÖ",
                type: "info",
              });
            };
          } else {
            classes += " hover:bg-pink-100 dark:hover:bg-zinc-700";
          }

          dayEl.className = classes;
          dayEl.innerText = day;
          calendarGrid.appendChild(dayEl);
        }
        monthEarningsEl.innerText = `${monthTotal.toFixed(2)}‚Ç¨`;
      }

      // --- SISTEMA DE MODALES PERSONALIZADOS ---

      function showModal({
        title,
        message,
        icon = "‚ú®",
        type = "info",
        onConfirm,
      }) {
        const overlay = document.getElementById("modal-overlay");
        const content = document.getElementById("modal-content");

        // Set content
        document.getElementById("modal-icon").innerHTML = icon;
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-message").innerHTML = message;

        const btnContainer = document.getElementById("modal-buttons");
        btnContainer.innerHTML = "";

        if (type === "confirm") {
          // Cancel
          const btnCancel = document.createElement("button");
          btnCancel.className =
            "flex-1 py-3 rounded-xl bg-gray-100 dark:bg-zinc-700 text-gray-500 dark:text-gray-300 font-bold text-sm active:scale-95 transition hover:bg-gray-200";
          btnCancel.innerText = "Cancelar";
          btnCancel.onclick = closeModal;
          btnContainer.appendChild(btnCancel);

          // Confirm
          const btnConfirm = document.createElement("button");
          btnConfirm.className =
            "flex-1 py-3 rounded-xl bg-pink-500 dark:bg-purple-600 text-white font-bold text-sm shadow-lg shadow-pink-200 dark:shadow-purple-900/50 active:scale-95 transition hover:brightness-110";
          btnConfirm.innerText = "S√≠, dale";
          btnConfirm.onclick = () => {
            if (onConfirm) onConfirm();
            closeModal();
          };
          btnContainer.appendChild(btnConfirm);
        } else {
          // Info (OK)
          const btnOk = document.createElement("button");
          btnOk.className =
            "w-full py-3 rounded-xl bg-gradient-to-r from-pink-400 to-rose-400 dark:from-purple-600 dark:to-indigo-600 text-white font-bold text-sm shadow-lg active:scale-95 transition hover:brightness-110";
          btnOk.innerText = "¬°Entendido!";
          btnOk.onclick = closeModal;
          btnContainer.appendChild(btnOk);
        }

        // Animaci√≥n Entrada
        overlay.classList.remove("hidden");
        setTimeout(() => {
          overlay.classList.remove("opacity-0");
          content.classList.remove("scale-95");
          content.classList.add("scale-100");
        }, 10);
      }

      function closeModal() {
        const overlay = document.getElementById("modal-overlay");
        const content = document.getElementById("modal-content");

        // Animaci√≥n Salida
        overlay.classList.add("opacity-0");
        content.classList.remove("scale-100");
        content.classList.add("scale-95");

        setTimeout(() => {
          overlay.classList.add("hidden");
        }, 300);
      }

      // --- INPUT & DATA LOGIC (Actualizada con Modales) ---

      function saveDefaultRate() {
        const newRate = settingsRateInput.value;
        if (newRate) {
          localStorage.setItem("hourlyRate", newRate);
          rateInput.value = newRate;
          showModal({
            title: "¬°Guardado!",
            message: "Tu tarifa favorita se ha guardado correctamente. üå∏",
            icon: isDark ? "üíæ" : "üíñ",
            type: "info",
          });
        }
      }

      function addEntry() {
        const rate = parseFloat(rateInput.value);
        const date = dateInput.value;
        const start = startInput.value;
        const end = endInput.value;

        if (!rate || !date || !start || !end) {
          showModal({
            title: "¬°Ups!",
            message: "Faltan datos por rellenar. <br>¬°No seas vaga! üòã",
            icon: "ü§î",
            type: "info",
          });
          return;
        }

        if (!localStorage.getItem("hourlyRate")) {
          localStorage.setItem("hourlyRate", rate);
        }

        const startTime = new Date(`2000-01-01T${start}`);
        let endTime = new Date(`2000-01-01T${end}`);
        if (endTime < startTime) endTime.setDate(endTime.getDate() + 1);

        const diffMs = endTime - startTime;
        const diffHrs = diffMs / (1000 * 60 * 60);
        const earned = diffHrs * rate;

        const newEntry = {
          id: Date.now(),
          date: date,
          start: start,
          end: end,
          rate: rate,
          hours: diffHrs.toFixed(2),
          earned: earned.toFixed(2),
        };

        entries.push(newEntry);
        startInput.value = "";
        endInput.value = "";

        updateApp();

        showModal({
          title: "¬°Apuntado!",
          message: `Has ganado <b>${earned.toFixed(2)}‚Ç¨</b> en este turno. <br>¬°Buen trabajo! ‚ú®`,
          icon: isDark ? "ü¶á" : "üéÄ",
          type: "info",
        });
      }

      function deleteEntry(id) {
        showModal({
          title: "¬øBorrar turno?",
          message:
            "Esta acci√≥n no se puede deshacer. <br>¬øSeguro que quieres borrarlo? üíî",
          icon: "üóëÔ∏è",
          type: "confirm",
          onConfirm: () => {
            entries = entries.filter((entry) => entry.id !== id);
            updateApp();
          },
        });
      }

      function clearAllData() {
        showModal({
          title: "¬øEST√ÅS SEGURA?",
          message:
            "Vas a borrar <b>TODO</b> tu historial. <br>No podr√°s recuperarlo. üò±",
          icon: "üî•",
          type: "confirm",
          onConfirm: () => {
            entries = [];
            updateApp();
            showModal({
              title: "Borrado",
              message: "Historial eliminado.",
              icon: "üßπ",
            });
          },
        });
      }

      function saveData() {
        localStorage.setItem("workEntries", JSON.stringify(entries));
      }

      // --- RENDERIZADO LISTA ---
      function renderEntries() {
        listContainer.innerHTML = "";

        if (entries.length === 0) {
          listContainer.innerHTML = `
                    <div class="text-center py-10 opacity-50 flex flex-col items-center">
                        <i class="fa-solid fa-ghost text-4xl mb-2 text-pink-300 dark:text-purple-700"></i>
                        <p class="font-kawaii text-sm">Lista vac√≠a...</p>
                    </div>`;
          totalEarningsEl.innerText = "0.00";
          return;
        }

        let totalEarned = entries.reduce(
          (acc, curr) => acc + parseFloat(curr.earned),
          0,
        );
        totalEarningsEl.innerText = totalEarned.toFixed(2);

        const grouped = {};
        entries.forEach((entry) => {
          if (!grouped[entry.date]) grouped[entry.date] = [];
          grouped[entry.date].push(entry);
        });

        Object.keys(grouped).forEach((dateKey) => {
          const dayEntries = grouped[dateKey];
          const dayTotal = dayEntries.reduce(
            (sum, e) => sum + parseFloat(e.earned),
            0,
          );
          const dateObj = new Date(dateKey);
          const dayName = dateObj.toLocaleDateString("es-ES", {
            weekday: "long",
            day: "numeric",
            month: "long",
          });

          const dayContainer = document.createElement("div");
          dayContainer.className =
            "bg-white dark:bg-zinc-800 rounded-2xl shadow-sm border border-pink-100 dark:border-purple-900 overflow-hidden animate-fade-in";

          let shiftsHTML = "";
          dayEntries.forEach((shift) => {
            shiftsHTML += `
                        <div class="flex justify-between items-center py-3 px-4 border-t border-gray-100 dark:border-gray-700 first:border-t-0 hover:bg-pink-50 dark:hover:bg-zinc-700/50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="bg-pink-100 dark:bg-purple-900/50 text-pink-500 dark:text-purple-300 rounded-lg p-2 text-xs font-bold min-w-[60px] text-center">
                                    ${shift.start}<br>‚¨á<br>${shift.end}
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-700 dark:text-gray-200">${shift.hours} horas</div>
                                    <div class="text-xs text-gray-400">@ ${shift.rate}‚Ç¨/h</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-chunky text-lg text-kitty-text dark:text-kuromi-accent">+${shift.earned}‚Ç¨</span>
                                <button onclick="deleteEntry(${shift.id})" class="text-gray-300 hover:text-red-400 p-1">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                    `;
          });

          dayContainer.innerHTML = `
                    <div class="bg-pink-50 dark:bg-zinc-900 px-4 py-2 flex justify-between items-center">
                        <span class="font-bold text-sm text-gray-600 dark:text-gray-300 capitalize">${dayName}</span>
                        <span class="bg-white dark:bg-zinc-700 px-2 py-0.5 rounded-md text-xs font-bold text-pink-500 dark:text-purple-300">Total: ${dayTotal.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div>${shiftsHTML}</div>
                `;

          listContainer.appendChild(dayContainer);
        });
      }

      // --- EXPORTAR / IMPORTAR (AJUSTES) ---
      function backupData() {
        const backup = {
          entries: entries,
          hourlyRate: localStorage.getItem("hourlyRate"),
          theme: localStorage.getItem("theme"),
          backupDate: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], {
          type: "application/json",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `workie_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function restoreData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);

            showModal({
              title: "¬øRestaurar Copia?",
              message: `Se encontraron ${data.entries?.length || 0} registros. <br>Esto reemplazar√° tu historial actual.`,
              icon: "üì¶",
              type: "confirm",
              onConfirm: () => {
                if (data.entries)
                  localStorage.setItem(
                    "workEntries",
                    JSON.stringify(data.entries),
                  );
                if (data.hourlyRate)
                  localStorage.setItem("hourlyRate", data.hourlyRate);
                if (data.theme) localStorage.setItem("theme", data.theme);

                showModal({
                  title: "¬°Restaurado!",
                  message: "La p√°gina se recargar√° ahora.",
                  icon: "üîÑ",
                  type: "info",
                  onConfirm: () => location.reload(), // Solo recarga al aceptar el modal
                });
                // Opcional: recargar tras un peque√±o delay si el usuario no pulsa nada
                setTimeout(() => location.reload(), 2000);
              },
            });
          } catch (error) {
            showModal({
              title: "Error",
              message: "El archivo no es v√°lido.",
              icon: "‚ùå",
              type: "info",
            });
          }
        };
        reader.readAsText(file);
        input.value = "";
      }

      function copyToClipboard() {
        if (entries.length === 0) {
          showModal({
            title: "Ups",
            message: "Nada que copiar todav√≠a. üï∏Ô∏è",
            icon: "üëª",
          });
          return;
        }

        const grouped = {};
        entries.forEach((e) => {
          if (!grouped[e.date]) grouped[e.date] = [];
          grouped[e.date].push(e);
        });
        let text = "‚ú® WORKIE - Historial ‚ú®\n\n";
        Object.keys(grouped).forEach((dateKey) => {
          const dayEntries = grouped[dateKey];
          const dateObj = new Date(dateKey);
          const dayStr = dateObj.toLocaleDateString("es-ES", {
            weekday: "short",
            day: "numeric",
            month: "numeric",
          });
          const dayTotal = dayEntries.reduce(
            (sum, e) => sum + parseFloat(e.earned),
            0,
          );
          text += `üìÖ ${dayStr} (Total: ${dayTotal.toFixed(2)}‚Ç¨)\n`;
          dayEntries.forEach((e) => {
            text += `   ‚ñ´Ô∏è ${e.start}-${e.end} (${e.hours}h) -> ${e.earned}‚Ç¨\n`;
          });
          text += "\n";
        });
        const totalE = entries.reduce(
          (acc, curr) => acc + parseFloat(curr.earned),
          0,
        );
        text += `üíñ TOTAL ACUMULADO: ${totalE.toFixed(2)}‚Ç¨ üíñ`;

        const el = document.createElement("textarea");
        el.value = text;
        el.setAttribute("readonly", "");
        el.style.position = "absolute";
        el.style.left = "-9999px";
        document.body.appendChild(el);
        el.select();
        try {
          document.execCommand("copy");
          showModal({
            title: "¬°Copiado!",
            message: "Ya puedes pegarlo en tus Notas. üìã",
            icon: "‚úÖ",
            type: "info",
          });
        } catch (err) {
          alert("Error.");
        }
        document.body.removeChild(el);
      }
    </script>
  </body>
</html>
